# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

sodaCat Explorer is a single-page app for browsing the [sodaCat](https://github.com/s13n/sodaCat) hardware database — register maps, chip comparison, and search across multiple vendors (ST, NXP). Pure static HTML/JS with zero runtime dependencies (no frameworks, no bundler, no npm).

## Development Commands

### Build data (required before first run)

```bash
python3 build.py \
  --vendor ST ../sodaCat/models/ST ../sodaCat/svd/ST/STM32.yaml STM32 \
  --vendor NXP ../sodaCat/models/NXP ../sodaCat/svd/NXP/LPC.yaml "" \
  --output-dir data
```

Requires the [sodaCat](https://github.com/s13n/sodaCat) repo cloned alongside this one, plus `pip install ruamel.yaml`. Each `--vendor` takes: `NAME MODELS_DIR CONFIG DISPLAY_PREFIX`.

### Serve locally

```bash
python3 -m http.server 8000
```

Open http://localhost:8000. No build step needed for JS/CSS changes — just reload.

### No test or lint tooling

There are no automated tests, linter, or formatter configured.

## Architecture

### Routing & Views

Hash-based SPA router (`js/router.js`) with cleanup function support. Routes are registered in `js/app.js`. Block paths are multi-segment (e.g., `#/block/H7/H742_H753/ADC`), so the router uses regex matching for `/block/` and `/block/.../reg/` routes instead of simple segment matching.

Route hierarchy: `/` → `/family/:code` → `/subfamily/:family/:sub` → `/chip/:family/:sub/:chip` → `/block/:path` → `/block/:path/reg/:reg`. Comparison routes: `/compare/chips/:a/:b`, `/compare/blocks/:a/:b`.

### Data Layer (`js/data.js`)

All data is pre-generated JSON in `data/` (not in git — built by `build.py`). Fetched on demand via `fetch()` with a 50-item LRU cache backed by `Map` insertion order. Key loaders: `loadIndex()`, `loadBlock(path)`, `loadBlockSummary(path)`, `loadChip(path)`. Large blocks (>50 KB) have a `.summary.json` for faster initial loads.

### Search (`js/search.js`)

Three-tier progressive loading: tier 1 (chips + blocks, immediate), tier 2 (registers, 3+ chars), tier 3 (fields, 4+ chars). Results scored by match type (exact > starts-with > contains) and weighted by item type (chip > block > register > field).

### DOM Creation

No templating library — DOM is built with `el(tag, attrs, ...children)` from `js/util.js`. This is a lightweight `document.createElement` wrapper supporting `className`, `onClick`, `style` (object), and `dataset` attributes.

### CSS

Two stylesheets: `css/main.css` (layout, typography, components) and `css/register-map.css` (32-bit register field grid visualization). Sepia color theme using CSS custom properties.

### Data Pipeline (`build.py`)

Multi-vendor Python script that converts sodaCat YAML models into JSON. Processes each vendor sequentially via repeatable `--vendor` CLI args. Outputs: `index.json` (family tree with vendor metadata), `blocks/*.json` (register maps), `chips/*.json` (instance info), `search-tier{1,2,3}.json` (search indices). Block path resolution follows a hierarchy: subfamily → family → shared. Chip detection uses known chip names from configs (not filename prefixes).

## Key Conventions

- All JS uses ES6 modules (`import`/`export`), loaded via `<script type="module">` in `index.html`
- View functions receive route params and optionally return a cleanup function
- Block paths encode scope: `WWDG` (shared), `H7/ADC` (family-level), `H7/H742_H753/ADC` (subfamily-level)
- `data/` directory is gitignored — always regenerated by `build.py` or CI
